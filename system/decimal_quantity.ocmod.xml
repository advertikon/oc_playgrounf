<?xml version="1.0" encoding="utf-8"?>
<modification>
	<name><![CDATA[
		Decimal quantity
		Adds ability to set decimal quantity for some products
	]]></name>
	<code>d_quantity</code>
	<version>1.0.0</version>
	<author></author>
	<link></link>
	<configuration>
		
	</configuration>
	
	<file path="system/library/cart/cart.php">
		<operation>
			<search>(int)$quantity</search>
			<add position="replace">(float)$quantity</add>
		</operation>

		<operation>
			<search><![CDATA[public function update($cart_id, $quantity) {]]></search>
			<add position="after"><![CDATA[
				$dq = $this->db->query( "select * from " . DB_PREFIX . "product_option po left join " . DB_PREFIX . "option_description od using(option_id) WHERE po.product_id = (SELECT product_id FROM " . DB_PREFIX . "cart WHERE cart_id = " .  (int)$cart_id . " LIMIT 1 ) AND LOWER( od.name ) = 'lățime perete (cm)'" );

				$decimal = false;

				if ( $dq && $dq->num_rows ) {
					$decimal = true;
				}

				if ( ! $decimal ) {
					$quantity = (int)$quantity;
				}
			]]></add>
		</operation>

		<operation>
			<search><![CDATA[if (!$query->row['total']) {]]></search>
			<add position="before"><![CDATA[
				$dq = $this->db->query( "select * from " . DB_PREFIX . "product_option po left join " . DB_PREFIX . "option_description od using(option_id) WHERE po.product_id = " . (int)$product_id . " AND LOWER( od.name ) = 'lățime perete (cm)'" );

				$decimal = false;

				if ( $dq && $dq->num_rows ) {
					$decimal = true;
				}

				if ( $decimal ) {
					$query->row['total'] = false;
				}
			]]></add>
		</operation>
	</file>

	<file path="catalog/controller/checkout/cart.php">

		<operation>
			<search><![CDATA[(int)$this->request->post['quantity']]]></search>
			<add position="replace"><![CDATA[(float)$this->request->post['quantity']]]></add>
		</operation>

		<operation>
			<search><![CDATA[if (isset($this->request->post['option'])) {]]></search>
			<add position="before"><![CDATA[
				$dq = $this->db->query( "select * from " . DB_PREFIX . "product_option po left join " . DB_PREFIX . "option_description od using(option_id) WHERE po.product_id = " . $product_id . " AND LOWER( od.name ) = 'lățime perete (cm)'" );

				$decimal = false;

				if ( $dq && $dq->num_rows ) {
					$decimal = true;
				}

				if ( ! $decimal ) {
					$quantity = (int)$quantity;
				}
			]]></add>
		</operation>

		<operation>
			<search><![CDATA[$this->cart->update($key, $value);]]></search>
			<add position="before"><![CDATA[

			]]></add>
		</operation>

	</file>

	<file path="catalog/controller/product/product.php">
		<operation>
			<search><![CDATA[$this->response->setOutput($this->load->view('product/product', $data));]]></search>
			<add position="before"><![CDATA[
				$data['width_option_id'] = 0;
				$data['height_option_id'] = 0;

				$qwo = $this->db->query( "SELECT po.product_option_id FROM " . DB_PREFIX . "option_description od LEFT JOIN " . DB_PREFIX . "product_option po USING(option_id) WHERE od.name = 'Înălțime perete (cm)' AND po.product_id = " . $product_id );
				$qho = $this->db->query( "SELECT po.product_option_id FROM " . DB_PREFIX . "option_description od LEFT JOIN " . DB_PREFIX . "product_option po USING(option_id) WHERE od.name = 'Lățime perete (cm)' AND po.product_id = " . $product_id );

				if ( $qwo && $qwo->num_rows ) {
					$data['width_option_id'] = $qwo->row['product_option_id'];
				}

				if ( $qho && $qho->num_rows ) {
					$data['height_option_id'] = $qho->row['product_option_id'];
				}

				$data['decimal_price'] = $data['special'] ? $data['special'] : $data['price'];
			]]></add>
		</operation>
	</file>

	<file path="catalog/view/theme/*/template/product/product.tpl">
		<operation error="skip">
			<search><![CDATA[<input type="text" name="quantity" value="<?php echo $minimum; ?>" size="2" id="input-quantity" class="form-control" />]]></search>
			<add position="replace"><![CDATA[
				<?php if ( $height_option_id && $width_option_id ) : ?>
				<input type="hidden" name="quantity" value="<?php echo $minimum; ?>" size="2" id="input-quantity" class="form-control"/>
				<?php else: ?>
				<input type="text" name="quantity" value="<?php echo $minimum; ?>" size="2" id="input-quantity" class="form-control" />
				<?php endif; ?>
			]]></add>
		</operation>

		<operation error="skip">
			<search><![CDATA[<div class="col-sm-12 quantity">]]></search>
			<add position="before"><![CDATA[
				<?php if ( $height_option_id && $width_option_id ) : ?>
				<label class="control-label" style="width: 100%; padding:0 20px; font-size: 1em;">
						<span style="float: left;"><b>Quantity:</b> <span id="decimal-quantity"></span> m<sup>2</sup></span>
						<span style="float: right;"><b>Price:</b> <span id="decimal-price" data-price="<?php echo $decimal_price; ?>"></span></span>
				</label>
				<?php else: ?>
				<label class="control-label" for="input-quantity"><?php echo $entry_qty; ?></label>
				<?php endif; ?>
			]]></add>
		</operation>

		<operation error="skip">
			<search><![CDATA[<?php echo $footer; ?>]]></search>
			<add position="before"><![CDATA[
				<?php if ( $height_option_id && $width_option_id ) : ?>
				<script>
					var
						heightElement =  null,
						widthElement =  null,
						priceElement = null,
						price = null;

					function getSquare() {
						var
							width = null,
							height = null,
							square = 0;

						if ( heightElement.length === 0 || widthElement.length === 0 ) {
							return square;
						}

						height = parseFloat( heightElement.val() );
						width = parseFloat( widthElement.val() );
						square = Math.max( 3, width * height / 10000 );

						$( "#decimal-quantity" ).text( square.toFixed( 2 ) );
						$( "#input-quantity" ).val( square );
						$( "#decimal-price" ).text( priceElement.attr( "data-price" ).replace( /\d+(\.\d+)?/, ( square * price ).toFixed( 2 ) ) );

						return square;
					}

					$( document ).ready( function() {
						$(".quantity > *:not(button)").hide();
						heightElement =  $( "#input-option<?php echo $height_option_id; ?>" ),
						widthElement =  $( "#input-option<?php echo $width_option_id; ?>" );
						priceElement = $( "#decimal-price" );
						price = parseFloat( priceElement.attr( "data-price" ).replace( /^.*?(\d+(\.\d+)?).*?$/, "$1" ) );

						heightElement.on( "input", getSquare );
						widthElement.on( "input", getSquare );

						getSquare();
					} );
					<?php endif; ?>
				</script>
			]]></add>
		</operation>
	</file>

</modification>


